// DOM Elements
const urlTable = document.getElementById('urlTable');
const allUrlsTable = document.getElementById('allUrlsTable');
const pagination = document.getElementById('pagination');
const searchForm = document.getElementById('searchForm');
const searchInput = document.getElementById('searchInput');
const refreshBtn = document.getElementById('refreshBtn');
const urlModal = new bootstrap.Modal('#urlModal');
const topUrlsChart = document.getElementById('topUrlsChart');

// Global variables
let currentPage = 1;
const itemsPerPage = 10;
let allUrls = [];
let filteredUrls = [];

// Event Listeners
document.addEventListener('DOMContentLoaded', loadDashboardData);
searchForm.addEventListener('submit', handleSearch);
refreshBtn.addEventListener('click', loadDashboardData);

// Load dashboard data
async function loadDashboardData() {
    try {
        const response = await fetch('/api/urls');
        const urls = await response.json();
        
        if (response.ok) {
            allUrls = urls;
            filteredUrls = [...urls];
            updateDashboardStats();
            renderRecentUrls();
            renderAllUrls();
        } else {
            showToast('Failed to load data', 'danger');
        }
    } catch (error) {
        showToast('Network error', 'danger');
    }
}

// Update dashboard statistics
function updateDashboardStats() {
    document.getElementById('totalUrls').textContent = allUrls.length;
    
    const totalClicks = allUrls.reduce((sum, url) => sum + url.clickCount, 0);
    document.getElementById('totalClicks').textContent = totalClicks;
    
    const activeUrls = allUrls.filter(url => 
        !url.expiresAt || new Date(url.expiresAt) > new Date()
    ).length;
    document.getElementById('activeUrls').textContent = activeUrls;
    
    const avgClicks = allUrls.length > 0 ? (totalClicks / allUrls.length).toFixed(1) : 0;
    document.getElementById('avgClicks').textContent = avgClicks;
}

// Render recent URLs
function renderRecentUrls() {
    const recentUrls = [...filteredUrls]
        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
        .slice(0, 5);
    
    urlTable.innerHTML = '';
    
    recentUrls.forEach(url => {
        const row = document.createElement('tr');
        row.dataset.id = url.id;
        row.addEventListener('click', () => showUrlDetails(url.id));
        
        row.innerHTML = `
            <td><a href="${url.shortKey}" target="_blank">${window.location.origin}/${url.shortKey}</a></td>
            <td>${url.clickCount}</td>
            <td>${formatDate(url.createdAt)}</td>
            <td><span class="status-badge ${getStatusClass(url)}">${getStatusText(url)}</span></td>
        `;
        
        urlTable.appendChild(row);
    });
}

// Render all URLs with pagination
function renderAllUrls() {
    const startIndex = (currentPage - 1) * itemsPerPage;
    const paginatedUrls = filteredUrls.slice(startIndex, startIndex + itemsPerPage);
    
    allUrlsTable.innerHTML = '';
    
    paginatedUrls.forEach(url => {
        const row = document.createElement('tr');
        row.dataset.id = url.id;
        row.addEventListener('click', () => showUrlDetails(url.id));
        
        row.innerHTML = `
            <td><a href="${url.shortKey}" target="_blank">${url.shortKey}</a></td>
            <td class="text-truncate" style="max-width: 300px;">${url.originalUrl}</td>
            <td>${url.clickCount}</td>
            <td>${formatDate(url.createdAt)}</td>
            <td>${url.lastAccessed ? formatDate(url.lastAccessed) : 'Never'}</td>
            <td><span class="status-badge ${getStatusClass(url)}">${getStatusText(url)}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-danger" data-id="${url.id}" onclick="deleteUrl(event, ${url.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        allUrlsTable.appendChild(row);
    });
    
    renderPagination();
}

// Render pagination controls
function renderPagination() {
    const totalPages = Math.ceil(filteredUrls.length / itemsPerPage);
    pagination.innerHTML = '';
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = '<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>';
    prevLi.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            renderAllUrls();
        }
    });
    pagination.appendChild(prevLi);
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        pageLi.addEventListener('click', () => {
            currentPage = i;
            renderAllUrls();
        });
        pagination.appendChild(pageLi);
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = '<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>';
    nextLi.addEventListener('click', () => {
        if (currentPage < totalPages) {
            currentPage++;
            renderAllUrls();
        }
    });
    pagination.appendChild(nextLi);
}

// Show URL details modal
async function showUrlDetails(urlId) {
    try {
        const response = await fetch(`/api/urls/${urlId}`);
        const url = await response.json();
        
        if (response.ok) {
            document.getElementById('modalShortUrl').textContent = `${window.location.origin}/${url.shortKey}`;
            document.getElementById('modalShortUrl').href = `${window.location.origin}/${url.shortKey}`;
            document.getElementById('modalOriginalUrl').textContent = url.originalUrl;
            document.getElementById('modalOriginalUrl').href = url.originalUrl;
            document.getElementById('modalCreatedAt').textContent = formatDate(url.createdAt, true);
            document.getElementById('modalExpiresAt').textContent = url.expiresAt ? formatDate(url.expiresAt, true) : 'Never';
            document.getElementById('modalClickCount').textContent = url.clickCount;
            document.getElementById('modalLastAccessed').textContent = url.lastAccessed ? formatDate(url.lastAccessed, true) : 'Never';
            document.getElementById('modalStatus').textContent = getStatusText(url);
            document.getElementById('modalStatus').className = `status-badge ${getStatusClass(url)}`;
            
            urlModal.show();
        } else {
            showToast('Failed to load URL details', 'danger');
        }
    } catch (error) {
        showToast('Network error', 'danger');
    }
}

// Delete URL
async function deleteUrl(event, urlId) {
    if (event) event.stopPropagation();
    
    if (!confirm('Are you sure you want to delete this URL?')) return;
    
    try {
        const response = await fetch(`/api/urls/${urlId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showToast('URL deleted successfully', 'success');
            loadDashboardData();
        } else {
            const error = await response.json();
            showToast(error.error || 'Failed to delete URL', 'danger');
        }
    } catch (error) {
        showToast('Network error', 'danger');
    }
}

// Handle search
function handleSearch(e) {
    e.preventDefault();
    const query = searchInput.value.trim().toLowerCase();
    
    if (query) {
        filteredUrls = allUrls.filter(url => 
            url.originalUrl.toLowerCase().includes(query) || 
            url.shortKey.toLowerCase().includes(query)
        );
    } else {
        filteredUrls = [...allUrls];
    }
    
    currentPage = 1;
    renderRecentUrls();
    renderAllUrls();
}

// Helper: Format date
function formatDate(dateString, full = false) {
    if (!dateString) return '';
    
    const date = new Date(dateString);
    return full ? 
        date.toLocaleString() : 
        date.toLocaleDateString();
}

// Helper: Get status text
function getStatusText(url) {
    if (!url.expiresAt) return 'Active';
    return new Date(url.expiresAt) > new Date() ? 'Active' : 'Expired';
}

// Helper: Get status class
function getStatusClass(url) {
    return getStatusText(url) === 'Active' ? 'status-active' : 'status-expired';
}

// Show toast notification
function showToast(message, type) {
    alert(`${type.toUpperCase()}: ${message}`);
}

// Expose delete function to window for HTML onclick
window.deleteUrl = deleteUrl;